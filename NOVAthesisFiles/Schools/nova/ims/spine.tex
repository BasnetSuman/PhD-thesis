%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% spine.tex
%% NOVA thesis document template
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Authors / Contributors:
%%      - João Lourenço <joao.lourenco@fct.unl.pt>
%%      - Tomás Monteiro <monteiro.tomas@gmail.com>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE nova/fct/spine.tex}



% Draw the book spine
% usable range: 145 to 425 pages, maximum characters for the title 140 and 22 for the author name
% usable range: 75 to 145 pages, maximum characters for the title 70 and 22 for the author name

\makeatletter
\sffamily
%=================================================================
% From https://tex.stackexchange.com/questions/26002/fit-text-into-given-box-by-adjusting-the-fontsize

\newdimen\fontdim
\newdimen\upperfontdim
\newdimen\lowerfontdim
\newif\ifmoreiterations
\fontdim12pt

\newbox\trialbox
\newbox\linebox
\global\newcount\maxbad
\newcount\linebad
\newcount\currenthbadness


\makeatletter
\NewEnviron{fitbox}[2]{% \begin{fitbox}{<width>}{<height>} stuff \end{fitbox}
    % Store environment body
    \def\stuff{%
        \BODY%
    }%
    % prepare badness box
    \def\badnessbox{%
        \global\maxbad=0\relax%
        \currenthbadness=\hbadness% save old \hbadness
        \hbadness=10000000\relax% make sure, TeX reports overfull boxes
        \message{Starting measureline recursion with width #1^^J}%
        \setbox\trialbox=\vbox{%
            \hsize#1\relax%
            \fontsize{\fontdim}{1.2\fontdim}%
            \selectfont%
            \stuff\par%
            \measurelines% start recursion
        }%
%       \noindent\usebox\trialbox\par
        \hbadness=\currenthbadness% restore old \hbadness
    }
    % prepare recursion to measure line badness
    \def\measurelines{%
        \message{Iteration of measurelines^^J}%
        \begingroup%
            \setbox\linebox=\lastbox% get the last line
            \setbox0=\hbox to \hsize{\unhcopy\linebox}% put the last line into box0 to provoke badness calculation
            \linebad=\the\badness\relax% \badness now reflects the last typeset box, i.e. box0
            \message{Badness: \the\badness\space\the\linebad\space with max \the\maxbad\space at Fontsize: \the\fontdim\space^^J}%
            \ifnum\linebad>\maxbad% store the maximum badness
                \global\maxbad=\linebad% Uncomment this line to ignore overfull hboxes!
            \fi%
            \ifvoid% end of recursion
                \linebox%
            \else%
                \unskip\unpenalty\measurelines% do the recursion
                \ifhmode%
                    \newline%
                \fi%
                \noindent\box\linebox% do the output
            \fi%
        \endgroup%
    }%
    % Prepare measurement box
    \def\buildbox{%
        \badnessbox% measure badness
        \setbox0\vbox{% measure height
            \hbox{%
                \fontsize{\fontdim}{1.2\fontdim}%
                \selectfont%
                \minipage{#1}%
                    \vbox{%                     
                        \stuff%\par%
                    }%
                \endminipage%
            }%
        }%
        \message{Measured badness: \the\maxbad\space at Fontsize: \the\fontdim\space^^J}%
        \dimen@\ht0
        \advance\dimen@\dp0
        \message{Measured box height: \the\dimen@\space^^J}%
    }%
    \def\shrinkheight{%
        \loop
            \fontdim.5\fontdim % Reduce font size by half
            \buildbox
            \message{Shrinking, new box height: \the\dimen@\space at Fontsize: \the\fontdim\space^^J}%
        \ifdim\dimen@>#2 \repeat
        \lowerfontdim\fontdim
        \upperfontdim2\fontdim
        \fontdim1.5\fontdim
    }%
    \def\shrinkwidth{%
        \loop
            \fontdim.5\fontdim % Reduce font size by half
            \buildbox
        \ifnum\maxbad>10000 \repeat
        \lowerfontdim\fontdim
        \upperfontdim2\fontdim
        \fontdim1.5\fontdim
    }%
    \def\growheight{%
        \loop
            \fontdim2\fontdim % Double font size
            \buildbox
            \message{Growing, new box height: \the\dimen@\space at Fontsize: \the\fontdim\space^^J}%
        \ifdim\dimen@<#2 \repeat
        \upperfontdim\fontdim
        \lowerfontdim.5\fontdim
        \fontdim.75\fontdim
    }%
    \buildbox
    % Compute upper and lower bounds
    \ifdim\dimen@>#2
        \message{Need to shrink box height: \the\dimen@\space^^J}%
        \shrinkheight
    \else
        \message{Need to grow box height: \the\dimen@\space to target: #2^^J}%
        \growheight
    \fi
    \message{Max font: \the\upperfontdim\space^^J}%
    \message{Min font: \the\lowerfontdim\space^^J}%
    % Potentially further reduce bounds for overfull box
    \ifnum\maxbad>10000
        \shrinkwidth
    \fi 
    \message{Max font adjusted: \the\upperfontdim\space^^J}%
    \message{Min font adjusted: \the\lowerfontdim\space^^J}%
    % Now try to find the optimum height and width
    \loop
        \buildbox
        \message{Height: \the\dimen@\space^^J}%
        \ifdim\dimen@>#2
            \moreiterationstrue
            \upperfontdim\fontdim
            \advance\fontdim\lowerfontdim
            \fontdim.5\fontdim
        \else
            \ifnum\maxbad>10000
                \moreiterationstrue
                \upperfontdim\fontdim
                \advance\fontdim\lowerfontdim
                \fontdim.5\fontdim
            \else
                \advance\dimen@-#2
                \ifdim\dimen@<10pt
                    \lowerfontdim\fontdim
                    \advance\fontdim\upperfontdim
                    \fontdim.5\fontdim
                    \dimen@\upperfontdim
                    \advance\dimen@-\lowerfontdim
                    \ifdim\dimen@<.2pt
                        \moreiterationsfalse
                    \else
                        \moreiterationstrue
                    \fi
                \else
                    \moreiterationsfalse
                \fi
            \fi
        \fi
    \ifmoreiterations \repeat
    \message{Selected font: \the\fontdim\space^^J}%
    \box0
    % \vbox to #2{\box0\hbox{}}% Typeset content
}%
%=================================================================

\newdata{novaims}
\novaims(title,box,len):={8.55cm}
\novaims(author,box,len):={5.1cm}
\novaims(title,text,len):={\dimexpr \thenovaims(title,box,len)-1mm}
\novaims(author,text,len):={\dimexpr \thenovaims(author,box,len)-1mm}

\newlength{\novathesis@spinewidth}%
\setlength{\novathesis@spinewidth}{1mm * (\thelastsheet+ 19) / 20}% replace \thelastsheet by 1581 to get 80mm width folder label or any other value as long as the width is bigger than 50mm 

\newlength{\novathesis@boxwidth}
\ifdim\novathesis@spinewidth > 6mm
  \setlength{\novathesis@boxwidth}{\novathesis@spinewidth-2mm}%
\else
  \setlength{\novathesis@boxwidth}{4mm}%
\fi
\newlength{\novathesis@spinetextwidth}
\setlength{\novathesis@spinetextwidth}{\novathesis@boxwidth-1mm}%


\newlength{\spine@len@top}
\setlength{\spine@len@top}{\thespine(top)}
\newlength{\spine@len@bottom}
\setlength{\spine@len@bottom}{\thespine(bottom)}
\newlength{\spine@len@name}
\setlength{\spine@len@name}{\widthof{\thespine(author)}}
\newlength{\spine@len@title}
\setlength{\spine@len@title}{\widthof{\thespine(title)}}
\newlength{\spine@len@year}
\setlength{\spine@len@year}{\widthof{\thespine(year)}}
\newlength{\spine@len@all}
\setlength{\spine@len@all}{\spine@len@year+\spine@len@name+\spine@len@title
                           +\spine@len@top+\spine@len@bottom}
\newlength{\spine@len@gap}
\setlength{\spine@len@gap}{\stockheight-\spine@len@all}
  
% \newcommand{\printlen}{%
%   stockheight=\printlength{\stockheight}\par
%   textheight=\printlength{\textheight}\par
%   textwidth=\printlength{\textwidth}\par
%   spine@len@margin=\printlength{\spine@len@margin}\par
%   spine@len@top=\printlength{\spine@len@top}\par
%   spine@len@name=\printlength{\spine@len@name}\par
%   spine@len@title=\printlength{\spine@len@title}\par
%   spine@len@year=\printlength{\spine@len@year}\par
%   spine@len@all=\printlength{\spine@len@all}\par
%   spine@len@gap=\printlength{\spine@len@gap}\par
% }

\newcommand{\spinetext}{%
  \thespine(font)%
  \hspace*{\spine@len@bottom}%
  \thespine(year)%
  \hspace*{0.33\spine@len@gap}%
  \thespine(title)%
  \hspace*{0.34\spine@len@gap}%
  \thespine(author)%
  \hspace*{0.33\spine@len@gap}%
  \hspace*{\spine@len@top}%
}

\newcommand{\ntprintspine}[1][]{%
  % \printlen%
  \defifundef{\myauthorbox}{\newsavebox}%%
  \begin{lrbox}{\myauthorbox}%
    \begin{minipage}[t][\novathesis@boxwidth][c]{\thenovaims(author,text,len)}%
      \begin{fitbox}{\linewidth}{\novathesis@spinetextwidth}%
        \thespine(author)%
      \end{fitbox}%
    \end{minipage}%
  \end{lrbox}%
  \defifundef{\mytitlebox}{\newsavebox}%%
  \begin{lrbox}{\mytitlebox}%
      \begin{fitbox}{\thenovaims(title,text,len)}{\novathesis@spinetextwidth}%
        \thespine(title)%
      \end{fitbox}%
  \end{lrbox}%
  \options{/@ntcoveropts/bookmark=spine}%
  \phantomsection\currentpdfbookmark{\option{/@ntcoveropts/bookmark}}{sipne}%
  \NTRunHook{spine/pre}%
  \IfStrEq{#1}{trim}{
    \setstocksize{\paperheight}{\novathesis@spinewidth}
    \settrimmedsize{\stockheight}{\stockwidth}{*}%
    \setlrmarginsandblock{0pt}{0pt}{*}%
    \setulmarginsandblock{0pt}{*}{1}%
    \setheadfoot{0pt}{0pt}%
    \setheaderspaces{0pt}{*}{*}%
    \checkandfixthelayout[fixed]%
    \ifluatex
        \pagewidth=\novathesis@spinewidth% \pageheight=3in
    \else
        \pdfpagewidth=\novathesis@spinewidth% \pdfpageheight=3in
    \fi
  }{}%
  \thispagestyle{empty}%
  \begin{tikzpicture}[remember picture, overlay]
  % draw image
    \node[inner sep=0] at (current page.center)
            {\includegraphics[width=\novathesis@spinewidth,height=\stockheight]%
                             {\thethesiscover(\option{/novathesis/docdegree},spine,image)}%
            };
    \node[inner sep=0,anchor=north,yshift=-5.3cm] at (current page.north)
            {\color{white}\rule{\novathesis@boxwidth}{\thenovaims(author,box,len)}};
    \node[inner sep=0,anchor=north,yshift=-5.35cm] at (current page.north)
            {\rotatebox{90}{\usebox{\myauthorbox}}};
    \node[inner sep=0,anchor=north,yshift=-15.8cm] at (current page.north) 
            {\color{white}\rule{\novathesis@boxwidth}{\thenovaims(title,box,len)}};
    \node[inner sep=0,anchor=north,yshift=-15.85cm] at (current page.north)
            {\rotatebox{90}{\usebox{\mytitlebox}}};
    \node[inner sep=0,anchor=north,yshift=-1.75cm] at (current page.north)
            {\rotatebox{90}{\color{white}\parbox{1.7cm}{\centering\Large\thedegreeacronym(\option{/novathesis/degree})}}};
    \node[inner sep=0,anchor=south,yshift=1.75cm] at (current page.south)
            {\rotatebox{90}{\parbox{1.7cm}{\centering\small\thentdateyear}}};
  \end{tikzpicture}
  \iftoggle{/novathesis/debugcover}{\debuggrid}{}%
  \NTRunHook{spine/post}%
}

