%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% spine.tex
%% NOVA thesis document template
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Authors / Contributors:
%%      - João Lourenço <joao.lourenco@fct.unl.pt>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE nova/fct/spine.tex}



% Draw the book spine
% usable range: 145 to 425 pages, maximum characters for the title 140 and 22 for the author name
% usable range: 75 to 145 pages, maximum characters for the title 70 and 22 for the author name

\makeatletter
\sffamily

\input{NOVAthesisFiles/fitbox.sty}

\spine(text,len,title):={\thespine(box,len,title)-\thespine(box,margin)-\thespine(box,margin)}
\spine(text,len,author):={\thespine(box,len,author)-\thespine(box,margin)-\thespine(box,margin)}
\spine(text,len,date):={\thespine(box,len,date)-\thespine(box,margin)-\thespine(box,margin)}

\newlength{\novathesis@spinewidth}%
\setlength{\novathesis@spinewidth}{\thespine(box,margin) * (\thelastsheet+ 19) / 20}% replace \thelastsheet by 1581 to get 80mm width folder label or any other value as long as the width is bigger than 50mm 

\newlength{\novathesis@boxwidth}
\ifdim\novathesis@spinewidth > 6mm
  \setlength{\novathesis@boxwidth}{\novathesis@spinewidth-2mm}%
\else
  \setlength{\novathesis@boxwidth}{4mm}%
\fi
\newlength{\novathesis@spinetextwidth}
\setlength{\novathesis@spinetextwidth}{\novathesis@boxwidth-\thespine(box,margin)}%

\newcommand{\ntprintspine}[1][]{%
  % \printlen%
  \ifdatadefined{spine}(text,color){\color{\thespine(text,color)}}{}%
  \defifundef{\myauthorbox}{\newsavebox}%%
  \begin{lrbox}{\myauthorbox}%
    \begin{minipage}[t][\novathesis@boxwidth][c]{\thespine(text,len,author)}%
      \begin{fitbox}{\linewidth}{\novathesis@spinetextwidth}%
        \thespine(author)%
      \end{fitbox}%
    \end{minipage}%
  \end{lrbox}%
  \defifundef{\mytitlebox}{\newsavebox}%%
  \begin{lrbox}{\mytitlebox}%
    \begin{minipage}[t][\novathesis@boxwidth][c]{\thespine(text,len,title)}%
      \begin{fitbox}{\linewidth}{\novathesis@spinetextwidth}%
        \thespine(title)%
      \end{fitbox}%
    \end{minipage}%
  \end{lrbox}%
  \defifundef{\mydatebox}{\newsavebox}%%
  \begin{lrbox}{\mydatebox}%
    \begin{minipage}[t][\novathesis@boxwidth][c]{\thespine(text,len,date)}%
      \begin{fitbox}{\linewidth}{\novathesis@spinetextwidth}%
        \thespine(date)%
      \end{fitbox}%
    \end{minipage}%
  \end{lrbox}%
  \options{/@ntcoveropts/bookmark=spine}%
  \phantomsection\currentpdfbookmark{\option{/@ntcoveropts/bookmark}}{sipne}%
  \NTRunHook{spine/pre}%
  \IfStrEq{#1}{trim}{
    \setstocksize{\paperheight}{\novathesis@spinewidth}
    \settrimmedsize{\stockheight}{\stockwidth}{*}%
    \setlrmarginsandblock{0pt}{0pt}{*}%
    \setulmarginsandblock{0pt}{*}{1}%
    \setheadfoot{0pt}{0pt}%
    \setheaderspaces{0pt}{*}{*}%
    \checkandfixthelayout[fixed]%
    \ifluatex
        \pagewidth=\novathesis@spinewidth% \pageheight=3in
    \else
        \pdfpagewidth=\novathesis@spinewidth% \pdfpageheight=3in
    \fi
  }{}%
  \thispagestyle{empty}%
  \begin{tikzpicture}[remember picture, overlay]
  % draw image
    % print bg color
    \ifdatadefined{thesiscover}(\option{/novathesis/docdegree},spine,bgcolor){%
      \node[inner sep=0] at (current page.center)
              {{\color{\thethesiscover{\option{/novathesis/docdegree},spine,bgcolor}}%
               \rule{\novathesis@spinewidth}{\paperheight}}};
    }{}%
    % print bg image
    \ifdatadefined{thesiscover}(\option{/novathesis/docdegree},spine,image){%
      \node[inner sep=0] at (current page.center)
              {\includegraphics[width=\novathesis@spinewidth,height=\paperheight]%
                               {\thethesiscover(\option{/novathesis/docdegree},spine,image)}%
              };
    }{}%
    % print author
    \ifdatadefined{spine}(box,color){%
      \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,top,author)})]
           at (current page.north)
              {{\color{\thespine(box,color)}\rule{\novathesis@boxwidth}{\thespine(box,len,author)}}};
    }{}
    \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,top,author)+\thespine(box,margin)})]
         at (current page.north)
            {\rotatebox{90}{\usebox{\myauthorbox}}};
    % print title
    \ifdatadefined{spine}(box,color){%
      \node[inner sep=0,anchor=north,yshift=-\expanded{\thespine(box,top,title)}]
           at (current page.north)
              {{\color{\thespine(box,color)}\rule{\novathesis@boxwidth}{\thespine(box,len,title)}}};
    }{}
    \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,top,title)+\thespine(box,margin)})]
         at (current page.north)
            {\rotatebox{90}{\usebox{\mytitlebox}}};
    % print degree
    % \node[inner sep=0,anchor=north,yshift=-1.75cm]
         % at (current page.north)
    %         {\rotatebox{90}{{\color{white}\parbox{1.7cm}{\centering\Large\thedegreeacronym(\option{/novathesis/degree})}}}};
    % print date
    \ifdatadefined{spine}(box,color){%
      \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,top,date)})]
           at (current page.north)
              {{\color{\thespine(box,color)}\rule{\novathesis@boxwidth}{\thespine(box,len,date)}}};
    }{}
    \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,top,date)+\thespine(box,margin)})]
         at (current page.north)
            {\rotatebox{90}{\usebox{\mydatebox}}};
  \end{tikzpicture}
  \iftoggle{/novathesis/debugcover}{\debuggrid}{}%
  \NTRunHook{spine/post}%
}
