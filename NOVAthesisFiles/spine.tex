%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% spine.tex
%% NOVA thesis document template
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Authors / Contributors:
%%      - João Lourenço <joao.lourenco@fct.unl.pt>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE spine.tex}%

% Draw the book spine
% usable range: 145 to 425 pages, maximum characters for the title 140 and 22 for the author name
% usable range: 75 to 145 pages, maximum characters for the title 70 and 22 for the author name

\makeatletter

\input{NOVAthesisFiles/fitbox2.sty}

% \def\def@ult#1(#2)=#3{\ifdatadefined{#1}(#2){}{\csname#1\endcsname(#2)={#3}}}

\spine(author)=?{\thedocauthor(name,short)}
\ifdatadefined{doctitle}(\@LANG@COVER,sub){%
  \spine(title)=?{\thedoctitle(\@LANG@COVER,spine):\\\thedoctitle(\@LANG@COVER,sub)}
}{%
  \spine(title)=?{\thedoctitle(\@LANG@COVER,spine)}
}
% \typeout{SPINE=[\@LANG@COVER][\thespine(title)]}
\spine(date)=?{\thentdocdate(year)}


% Defaults for spine
\spine(logo):=?{none}
\spine(order):=?{date,title,author,logo}
\spine(angle):=?{0}
\spine(boxsep):=?{0.5cm}
\spine(image):=?{none}
\spine(bg,color):=?{none}
\spine(frame,color):=?{black!50}
\spine(text,color):=?{black}
\spine(text,align):=?{c}
\spine(margin,top):=?{1mm}
\spine(margin,bottom):=?{1mm}
\spine(margin,left):=?{0.5cm}
\spine(margin,right):=?{0.5cm}

% Defaults for spine boxes
\spine(box,margin):=?{0.5mm}
\spine(box,bg,color):=?{none}
\spine(box,text,color):=?{black}

\spine(box,logo,len):=?{4.1cm}
\spine(box,logo,angle)=?{0}
\spine(box,logo,align):=?{c}
\spine(box,logo,raise):=?{0pt}
\spine(box,logo,scale):=?{1}
\spine(box,logo,margin,left)=?{0.0cm}
\spine(box,logo,margin,right):=?{0.0cm}

\spine(box,author,len):=?{4.0cm}
\spine(box,author,angle)=?{\thespine(angle)}
\spine(box,author,align)=?{\thespine(text,align)}
\spine(box,author,margin,left):=?{0pt}
\spine(box,author,margin,right):=?{0pt}

\spine(box,title,len):=?{16.7cm}
\spine(box,title,angle)=?{\thespine(angle)}
\spine(box,title,align):=?{\thespine(text,align)}
\spine(box,title,margin,left):=?{0pt}
\spine(box,title,margin,right):=?{0pt}

\spine(box,date,len):=?{2.0cm}
\spine(box,date,angle)=?{\thespine(angle)}
\spine(box,date,align):=?{\thespine(text,align)}
\spine(box,date,margin,left):=?{0pt}
\spine(box,date,margin,right):=?{0pt}



\newif\ifisdim
\newcommand{\@setifisdim}[1]{%
  \StrLeft{#1}{1}[\@dimleft]%
  \StrRight{#1}{1}[\@dimright]%
  \IfInteger{\@dimleft}{%
    \IfInteger{\@dimright}{%
      % Is a number
      \isdimfalse%
    }{%
      % May be a dimension
      \isdimtrue%
    }%
  }{%
    % Is a string
    \isdimfalse%
  }%
}
\newcommand{\IfIsDim}[3]{%
  \@setifisdim{#1}%
  \ifisdim#2\else#3\fi%
}


\newlength{\@spinelen}  % total spine length
\newlength{\@spineboxlen} % accumulated spine boxes length (= \@spinefixedlen + \@spinevarlen)
\newlength{\@spinefixedlen} % accumulated spine fixed boxes length
\newlength{\@spinevarlen} % accumulated spine variable boxes length
\newlength{\@spineboxseplen} % accumulated box separators length
\newlength{\@spinelr} % accumulated left and right length
\newlength{\@spinevarratio} % ratio for scaling the variable boxes
\StrCount{\thespine(order)}{,}[\@spineNBoxes]%
\typeout{NBOXES=\@spineNBoxes}%


\newcommand{\@getspinelen}{%
  \setlength{\@spinelr}{\dimexpr\thespine(margin,left)+\thespine(margin,right)\relax}%
  \setlength{\@spineboxseplen}{\dimexpr \thespine(boxsep)*3\relax}%
  \setlength{\@spinefixedlen}{\dimexpr \@spinelr+\@spineboxseplen\relax}
  \setlength{\@spineboxlen}{0pt}
  \setlength{\@spinevarlen}{0pt}
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \@tempdima=\dimexpr \thespine(box,\myi,len)\relax%
    \spine(box,\myi,len):={\the\@tempdima}
    \typeout{SPINEBOXLEN[\myi]=\the\@tempdima}
    \addtolength{\@spineboxlen}{\@tempdima}
    \ifdatadefined{spine}(box,\myi,len){%
      % Fixed box length
      \addtolength{\@spinefixedlen}{\@tempdima}
    }{%
      % Variable box length
      \addtolength{\@spinevarlen}{\@tempdima}
    }%
  }%
  \setlength{\@spinelen}{\dimexpr \@spinefixedlen+\@spinevarlen\relax}
  \typeout{SPINELEN[lr]=\the\@spinelr}%
  \typeout{SPINELEN[boxseplen]=\the\@spineboxseplen}%
  \typeout{SPINELEN[boxlen]=\the\@spineboxlen}%
  \typeout{SPINELEN[boxfixedlen]=\the\@spinefixedlen}%
  \typeout{SPINELEN[boxvarlen]=\the\@spinevarlen}%
  \typeout{SPINELEN[spinelen]=\the\@spinelen}%
  \typeout{SPINELEN[spinelen]=\the\@spinelen}%
}

\newlength{\@displen}
\newcommand{\displayspinealyout}{
  \@for\@myitem:={%
        {order},{angle},{boxsep},{image},{frame,color},{bg,color},{text,color},{text,align},%
        {margin,left},{margin,right},{margin,top},{margin,bottom},%
        {box,margin},{box,bg,color},{box,text,color},%
        {box,logo,angle},{box,author,angle},{box,title,angle},{box,date,angle},%
        {box,logo,len},{box,author,len},{box,title,len},{box,date,len},%
        {box,logo,margin,left},{box,author,margin,left},{box,title,margin,left},{box,date,margin,left},%
        {box,logo,margin,right},{box,author,margin,right},{box,title,margin,right},{box,date,margin,right}%
  }\do{%
    \IfIsDim{\thespine(\@myitem)}{%
      \setlength{\@displen}{\thespine(\@myitem)}
      \typeout{\string\thespine(\@myitem)=\thespine(\@myitem)=\the\@displen}
    }{%
      \typeout{\string\thespine(\@myitem)=\thespine(\@myitem)}
    }%
  }%
}


% \displayspinealyout
\@getspinelen
% \typeout{PAPER HEIGHT=\the\paperheight}
% \typeout{SPINELEN[TEMP]=\the\@spinelen}
% \PAUSETHIS

\providecommand*{\DivideLengths}[2]{%
  \strip@pt\dimexpr\number\numexpr\number\dimexpr#1\relax*65536/\number\dimexpr#2\relax\relax sp\relax
}

% If angle is 180 rever the order
\IfStrEq{\thespine(angle)}{180}{%
  \spine(margin,left2):={\thespine(margin,left)}%
  \spine(margin,left):={\thespine(margin,right)}%
  \spine(margin,right):={\thespine(margin,left2)}%
  \def\spineorder{}%
  \typeout{ORDER BEFORE=\thespine(order)}%
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \epreto\spineorder{,\myi}%
  }%
  \edef\spineorder{\expandafter\@gobble\spineorder}%
  \spine(order):={\spineorder}%
  % \StrGobbleRight{\spineorder}{2}%
  \typeout{ ORDER AFTER=\thespine(order)}%
}{%
}%

% Increase box spacing if necessary
% Reduce default boxes length and keep given/forces boxes length 
\newlength{\@newboxsep}
\ifdim\@spinelen<\paperheight\relax%
  % SPINE boxes do not fill up all the spine, increase spacing
  \@tempdima=\dimexpr\thespine(boxsep)\relax%
  \typeout{OLD BOXSEP=\the\@tempdima}
  \@tempdima=\dimexpr((\paperheight-\@spinelen)+(\expanded{\thespine(boxsep)}*\@spineNBoxes))
                     /\@spineNBoxes\relax%
  \spine(boxsep):={\the\@tempdima}%
\else\ifdim\@spinelen>\paperheight\relax%
  % SPINE boxes are to large for the spine size, decrease spacing in the not-explictily defined boxes
  \@tempdima=\dimexpr\paperheight-\@spinefixedlen\relax
  % \showthe\@tempdima
  \@tempdimb=\dimexpr\@spinelen-\@spinefixedlen\relax
  % \showthe\@tempdimb
  % \StrGobbleRight{\the\@tempdimb}{2}[\@SPVAR]
  \edef\@spinevarratio{\DivideLengths{\@tempdima}{\@tempdimb}}
  % \show\@spinevarratio
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \ifdatadefined{spine}(box,\myi,len){%
      % Fixed box length, do not touch
    }{%
      % Variable box length, apply ratio
    \@tempdima=\dimexpr\thespine(box,\myi,len)\relax%
    \typeout{OLD SPINEBOXLEN[\myi]=\the\@tempdima}
    \@tempdima=\dimexpr \@spinevarratio\@tempdima\relax
    \typeout{NEW SPINEBOXLEN[\myi]=\the\@tempdima}
    \spine(box,\myi,len):={\the\@tempdima}
    }%
  }%
\fi\fi%

% \displayspinealyout
\@getspinelen
% \typeout{PAPER HEIGHT=\the\paperheight}
% \typeout{SPINELEN[FINAL]=\the\@spinelen}
% \PAUSETHIS

% Calculate box[lef], box[len], box[right]
\@tempdima=\dimexpr\thespine(margin,left)-\thespine(boxsep)\relax%
\@for\myi:=\expanded{\thespine(order)}\do{
  \@tempdima=\dimexpr\@tempdima+\thespine(boxsep)\relax%
  \spine(box,\myi,left):={\the\@tempdima}
  \@tempdima=\dimexpr\@tempdima+\thespine(box,\myi,len)\relax%
  \spine(box,\myi,right):={\the\@tempdima}
  \typeout{BOX[\myi,left]=\thespine(box,\myi,left)}
  \typeout{BOX[\myi,len]=\thespine(box,\myi,len)}
  \typeout{BOX[\myi,right]=\thespine(box,\myi,right)}
}%

\@for\myi:=\expanded{\thespine(order)}\do{%
  \@tempdima=\dimexpr\thespine(box,\myi,len)\relax
  \spine(box,\myi,len):={\the\@tempdima}
  \@tempdima=\dimexpr\@tempdima-\thespine(box,\myi,margin,left)
                               -\thespine(box,\myi,margin,right)\relax
  \spine(box,\myi,len2):={\the\@tempdima}
  \typeout{TEXT[\myi,len]=\thespine(box,\myi,len)}  
  \typeout{TEXT[\myi,len2]=\thespine(box,\myi,len2)}  
}


\newcommand{\@spinetextalin}[1]{%
  \datamatchtf{\arg}{spine}({box,#1,align},{text,align}){}{%
    \ClassError{novathesis}{Invalid spine text alignment for “#1”}{}%
  }%
  \IfStrEqCase{\arg}{%
    {l}{\raggedright}%
    {c}{\centering}%
    {r}{\raggedleft}%
  }%
}


\newcommand{\@setlength}[2]{%
  \defifundef{#1}{\newlength}%
  \@tempdima=\dimexpr#2\relax%
  \setlength{#1}{\the\@tempdima}%
}

\newcommand{\ifnotnone}[2]{%
  \IfStrEq{none}{#1}{}{#2}%
}

\newcommand{\@ntprintspine}{%
\ifoptionequal{/novathesis/spine/layout}{none}{}{%
  \parindent=0pt%
  \sffamily%
  \linespread{0.85}%
  \normalsize%
  \ifdim\option{/novathesis/spine/width}=0pt\relax%
    \@setlength{\@spinewidth}{0.05mm * (\thelastsheet+1)}%
    \typeout{NOVATHESIS spine width for \thelastsheet\space pages is \the\@spinewidth!}%
    \ifdim\@spinewidth < 6mm\relax% Force book spine to be at least 6mm
      \typeout{NOVATHESIS spine width was \the\@spinewidth, forcing to 6mm!}%
      \@setlength{\@spinewidth}{6mm}%
    \fi%
  \else%
    \@setlength{\@spinewidth}{\option{/novathesis/spine/width}}%
    \typeout{NOVATHESIS spine width user forced by user to \the\@spinewidth!}%
  \fi%
  \typeout{NOVATHESIS \string\@spinewidth=\the\@spinewidth}%
  \@setlength{\@thespinewidth}
             {\dimexpr\@spinewidth-\thespine(margin,top)-\thespine(margin,bottom)\relax}%
  \def\@fbratio{9999}%
  \@for\myi:=\expanded{\thespine(order)}\do{%
    \IfStrEq{\myi}{title}{%
      \fitboxratio{@\myi RT}{\thespine(box,\myi,len2)}{\@thespinewidth}{\thespine(\myi)}%
      \fitboxratio{@\myi 2RT}{\thespine(box,\myi,len2)}{\@thespinewidth}{\def\\{ }\thespine(\myi)}%
      \pgfmathparse{\csuse{@\myi RT}}%
      \edef\@tone{\pgfmathresult}%
      \pgfmathparse{\csuse{@\myi 2RT}}%
      \edef\@ttwo{\pgfmathresult}%
      % \typeout{T1=\@tone\space T2=\@ttwo}\AAAAA%
      \ifdim\@tone pt < \@ttwo pt\relax%
        % \BBBBBBB%
        \spine(\myi):={\def\\{ }\thespine(\myi)}%
      \fi%
    }{}%
    \IfStrEq{\myi}{logo}{}{%
      \fitboxratio{@\myi RT}{\thespine(box,\myi,len2)}{\@thespinewidth}{\thespine(\myi)}%
      \typeout{NOVATHESIS RATIO[\myi]=\csuse{@\myi RT}}%
      \pgfmathparse{min(\@fbratio,\csuse{@\myi RT})}%
      \typeout{NOVATHESIS RATIO MIN(\@fbratio,\csuse{@\myi RT})=\pgfmathresult}%
      \edef\@fbratio{\pgfmathresult}%
    }%
  }%
  \typeout{NOVATHESIS RATIO=\@fbratio}
  \currentpdfbookmark{\thebkmstring(spine)}{thespine}%
  \ifoptionequal{/novathesis/spine/layout}{trim}{%
    \stockwidth=\stockheight%
    \stockheight=\@spinewidth%
  }{\ifoptionequal{/novathesis/spine/layout}{full}{%
    \let\oldstockwidth=\stockwidth
    \stockwidth=\stockheight%
    \stockheight=21cm%
  }{%
    \ClassError{novathesis}{Unknown page dimensions for “spine/layout=\option{/novathesis/spine/layout}”}
  }}%
  \paperwidth=\stockwidth%
  \paperheight=\stockheight%
  \setstocksize{\stockheight}{\stockwidth}%
  \settrimmedsize{\stockheight}{\stockwidth}{*}%
  % \paperheight=\@spinewidth%
  \setlrmarginsandblock{0pt}{0pt}{*}%
  \setulmarginsandblock{0pt}{*}{1}%
  \setheaderspaces{0pt}{*}{*}%
  \footskip=0pt%
  \checkandfixthelayout[fixed]%
  \ifluatex%
  \pagewidth=\paperwidth%
  \pageheight=\paperheight% \pageheight=3in
  \else%
  \pdfpagewidth=\paperwidth%
  \pdfpageheight=\paperheight% \pageheight=3in
  \fi%
  \thispagestyle{empty}%
  \NTRunHook{spine/pre}%
  % \PAUSETHIS
  \ifoptionequal{/novathesis/spine/layout}{trim}{\@tempdima=0pt}{\@tempdima=\dimexpr(\stockheight-\@spinewidth)/2\relax}%
  \begin{tikzpicture}[remember picture, overlay,yscale=-1,yshift=-10.75pt+\@tempdima]%
    % print spine bg color IF DEFINED
    \datamatchtf{\arg}{spine}(%
                      {\@DOCTYPE,bg,color},%
                      {\@DOCCLASS,bg,color},%
                      {bg,color},%
    ){\ifnotnone{\arg}{\fill [color=\arg] (0,0) rectangle (\paperwidth,\paperheight);}}{%
      \ClassError{novathesis}{Undefined spine “bg,color”}{}%
    }%
    % print frame IF DEFINED
    \ifoptionequal{/novathesis/spine/layout}{full}{%
      \datamatchtf{\arg}{spine}(%
                        {\@DOCTYPE,frame,color},%
                        {\@DOCCLASS,frame,color},%
                        {frame,color}%
      ){\ifnotnone{\arg}{\draw [color=\arg] (0,0) rectangle (\paperwidth-0.4pt,\@spinewidth-0.4pt);}}{%
        \ClassError{novathesis}{Undefined spine “frame,color”}{}%
      }%
    }{}%
    % print bg image IF DEFINED
    \datamatchtf{\arg}{thesiscover}({\@DOCTYPE,spine,image},{\@DOCCLASS,spine,image},{spine,image}){%
      \ifnotnone{\arg}{%
        \node[inner sep=0] at (current page.center)
                {\includegraphics[width=\paperheight,height=\paperwidth,
                                  angle=\number\numexpr\thespine(angle)-90\relax]{\arg}};
      }}{%
          \datamatchtf{\arg}{spine}(%
                        {\@DOCTYPE,image},%
                        {\@DOCCLASS,image},%
                        {image},%
      ){%
          \ifnotnone{\arg}{%
            \node[inner sep=0] at (current page.center)
                    {\includegraphics[width=\paperheight,height=\paperwidth,
                                      angle=\number\numexpr\thespine(angle)-90\relax]{\arg}};
      }}{%
        \ClassError{novathesis}{Undefined spine “image”}{}%
      }%
    }%
    \@for\myi:=\expanded{\thespine(order)}\do{%
      \node[rectangle,
            inner sep = 0pt,
            anchor = north west,
            % draw, color = red,
            fill = {\thespine(box,bg,color)},
            minimum width = \expanded{\thespine(box,\myi,len)},
            minimum height = \@thespinewidth,
      ] (r\myi) at (\thespine(box,\myi,left),\expanded{\thespine(margin,top)}) {};
      % \node[inner sep = 0pt, anchor=west] at (\thespine(box,\myi,left),0.5\@spinewidth) {\myi};
      % \node[inner sep = 0pt, anchor=east] at (\thespine(box,\myi,right),0.5\@spinewidth) {\myi};
      % \node[inner sep = 0pt, anchor=center,color=blue] at (r\myi) {\myi};
      % \draw [color=red]
      %         (\thespine(box,\myi,left),\expanded{\thespine(margin,top)})
      %         rectangle
      %         (\thespine(box,\myi,right),\dimexpr\the\@spinewidth-\expanded{\thespine(margin,top)}\relax)
      %         node[pos=.5,color=black,align=left] {};
      \datamatchtf{\@align}{spine}({box,\myi,align},{\myi,align}){}{%
        \ClassError{novathesis}{Invalid spine text alignment for “\myi”}{}%
      }%
      \IfStrEqCase{\@align}{%
        {l}{\node [inner sep=0, anchor=west] at (r\myi.west)
              {\printspinebox{\myi}{\@fbratio}};}%
        {c}{\node [inner sep=0, anchor=center] at (r\myi)
              {\printspinebox{\myi}{\@fbratio}};}%
        {r}{\node [inner sep=0, anchor=east] at (r\myi.east)
              {\printspinebox{\myi}{\@fbratio}};}%
      }%
    }%
  \end{tikzpicture}%
  \ifoptioncontains{/novathesis/debug}{cover}{%
    \NTRunHook{cover/spine/grid/pre}%
    \debuggrid%
    \NTRunHook{cover/spine/grid/post}%
  }{}%
}}

\newcommand{\printspinebox}[2]{%
  % 1=spine box name
  % 2=ratio
  \datamatchtf{\@item}{spine}(%
                    {#1,\@DOCCLASS},%
                    {#1,\@DOCTYPE},%
                    {#1}%
  ){}{\ClassError{novathesis}{Undefined spine element: #1}{}}%
  \datamatchtf{\@angle}{spine}(%
                    {box,#1,\@DOCTYPE,angle},%
                    {box,#1,\@DOCCLASS,angle},%
                    {box,#1,angle},%
                    {#1,\@DOCTYPE,angle},%
                    {#1,\@DOCCLASS,angle},%
                    {#1,angle}%
  ){}{\def\@angle{\thespine(angle)}}%
  \datamatchtf{\@scale}{spine}(%
                    {box,#1,\@DOCTYPE,scale},%
                    {box,#1,\@DOCCLASS,scale},%
                    {box,#1,scale}%
                    {#1,\@DOCTYPE,scale},%
                    {#1,\@DOCCLASS,scale},%
                    {#1,scale}%
  ){}{\def\@scale{1}}%
  \datamatchtf{\@raise}{spine}(%
                    {box,#1,\@DOCTYPE,raise},%
                    {box,#1,\@DOCCLASS,raise},%
                    {box,#1,raise}%
                    {#1,\@DOCTYPE,raise},%
                    {#1,\@DOCCLASS,raise},%
                    {#1,raise}%
  ){}{\def\@raise{0pt}}%
  % \typeout{L=[\thespine(logo)] IT(#1)=[\@item]}\AAAA
  \typeout{PRINT BOX #1  ITEM=\@item}%
  \typeout{PRINT BOX #1 ANGLE=\@angle}%
  \typeout{PRINT BOX #1 SCALE=\@scale}%
  \typeout{PRINT BOX #1 RAISE=\@raise}%
  \IfStrEq{#1}{logo}{%
    % IMAGE
    \IfStrEq{\@item}{none}{}{%
      \def\@boxscale{1}%
      \edef\@logowidth{\thespine(box,logo,len2)}\edef\@logoheight{\@thespinewidth}%
      % \typeout{W=\@logowidth\space H=\the\@logoheight=\the\@thespinewidth}\XXXX
      \setbox0=\hbox{\includegraphics[width=\@logowidth,angle=\number\numexpr\@angle\relax]{\@item}}%
      \ifdim\dimexpr\ht0+\dp0\relax>\@logoheight\relax%
        \setbox0=\hbox{\includegraphics[height=\@logoheight,angle=\number\numexpr\@angle-90\relax]{\@item}}%
      \fi%
      \scalebox{\@scale}{\box0}%
    }%
  }{%
    % TEXT
    \scalebox{\@fbratio}{%
      \datamatchtf{\arg}{spine}({box,#1,text,color},{box,text,color},%
                                {text,color}){\color{\arg}}{}%
      % \datamatchtf{\@sptx}{spine}({#1,nova/itqb},{#1}){}{}%
      \ifdatadefined{spine}(#1,\@UNIV/\@SCHL){%
        \tabular{@{}c@{}}\thespine(#1,\@UNIV/\@SCHL)\endtabular%
      }{%
        \tabular{@{}c@{}}\thespine(#1)\endtabular%
      }%
    }%
  }%
  % \PAUSETHIS
}

