%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% spine.tex
%% NOVA thesis document template
%%
%% This work is licensed under the
%% The LaTeX project public license (LPPL), version 1.3c
%% To view a copy of this license, visit
%% https://www.latex-project.org/lppl/lppl-1-3c/
%%
%% Authors / Contributors:
%%      - João Lourenço <joao.lourenco@fct.unl.pt>
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\typeout{NT FILE spine.tex}%

% Draw the book spine
% usable range: 145 to 425 pages, maximum characters for the title 140 and 22 for the author name
% usable range: 75 to 145 pages, maximum characters for the title 70 and 22 for the author name

\makeatletter
\sffamily

\input{NOVAthesisFiles/fitbox2.sty}

\RequirePackage{anysize}

\ifdatadefined{spine}(author){%
  \spine(text,author,len):={\dimexpr\thespine(box,author,len)-\thespine(box,margin)-\thespine(box,margin)}
}{}
\ifdatadefined{spine}(title){%
  \spine(text,title,len):={\dimexpr\thespine(box,title,len)-\thespine(box,margin)-\thespine(box,margin)}
}{}
\ifoptionvoid{/novathesis/degreeacr}{}{%
  \spine(text,degree,len):={\dimexpr\thespine(box,degree,len)-\thespine(box,margin)-\thespine(box,margin)}
}
\ifdatadefined{spine}(date){%
  \spine(text,date,len):={\dimexpr\thespine(box,date,len)-\thespine(box,margin)-\thespine(box,margin)}
}{}


\newcommand{\@spinetextalin}[1]{%
  \raggedright%
  \IfStrEqCase{\thespine(box,#1,align)}{%
    {l}{\raggedright}%
    {c}{\centering}%
    {r}{\raggedleft}%
  }%
}

\newcommand{\@spinetextcolor}[1]{%
  \ifdatadefined{spine}(box,#1,textcolor){%
    \color{\thespine(box,#1,textcolor)}%
  }{\ifdatadefined{spine}(text,color){%
    \color{\thespine(text,color)}%
  }{}%
  }%
}

\newcommand{\ntprintspine}[1][]{%
  \footnotesize
  \newlength{\novathesis@spinewidth}%
  % \setlength{\novathesis@spinewidth}{\dimexpr0.11mm*\thelastsheet/2}% replace \thelastsheet by 1581 to get 80mm width folder label or any other value as long as the width is bigger than 50mm
  \setlength{\novathesis@spinewidth}{1mm * (\thelastsheet+ 19) / 20}% replace \thelastsheet by 1581 to get 80mm width folder label or any other value as long as the width is bigger than 50mm
  \typeout{NT SPINE width(\thelastsheet)=\the\novathesis@spinewidth}%
  \ifdim\novathesis@spinewidth < 6mm%
    \setlength{\novathesis@spinewidth}{6mm}%
    \typeout{NT SPINE forcing spine(width)=6mm}%
  \fi%
  \newlength{\novathesis@boxwidth}%
  \setlength{\novathesis@boxwidth}{\novathesis@spinewidth-1mm}%
  \newlength{\novathesis@spinetextwidth}%
  \setlength{\novathesis@spinetextwidth}{\dimexpr\novathesis@boxwidth-\thespine(box,margin)-\thespine(box,margin)}%
  % \printlen%
  \typeout{NT SPINE thespine(sipne,width)=\the\novathesis@spinewidth}%
  \typeout{NT SPINE thespine(sipne,boxwidth)=\the\novathesis@boxwidth}%
  \typeout{NT SPINE thespine(sipne,textwidth)=\the\novathesis@spinetextwidth}%
  \ifdatadefined{spine}(author){%
    \typeout{NT SPINE \string\thespine(box,author,len)=\thespine(box,author,len)}%
    \typeout{NT SPINE \string\thespine(text,author,len)=\thespine(text,author,len)}%
    \begin{fitboxfontsize}{\thespine(text,author,len)}{\novathesis@spinetextwidth}{\fnts@author}%
      {\thespine(author)}%
    \end{fitboxfontsize}
    \typeout{NT SPINE \string\fontsize(author)=\fnts@author}%
  }{\def\fnts@author{100pt}\def\blsk@author{100pt}}%
  \ifdatadefined{spine}(title){%
    \typeout{NT SPINE \string\thespine(box,title,len)=\thespine(box,title,len)}%
    \typeout{NT SPINE \string\thespine(text,title,len)=\thespine(text,title,len)}%
    \begin{fitboxfontsize}{\thespine(text,title,len)}{\novathesis@spinetextwidth}{\fnts@title}%
      {X\thespine(title)}%
    \end{fitboxfontsize}
    \typeout{NT SPINE \string\fontsize(title)=\fnts@title}%
  }{\def\fnts@title{100pt}\def\blsk@title{100pt}}%
  % \begin{fitbox}{\thespine(text,date,len)}{\novathesis@spinetextwidth}{\@datesize}%
  %   \thespine(date)%
  % \end{fitbox}%
  % author=\@authorsize\par
  % title=\@titlesize\par
  \let\fnts@spine\fnts@author
  % \let\blsk@spine\blsk@author
  \ifdim\fnts@title<\fnts@spine\relax
    \let\fnts@spine\fnts@title
    % \let\blsk@spine\blsk@title
  \fi
  % \StrCut{\fnts@spine}{.}\@fsleft\@fsright%
  % \fontsize{\@fsleft-2pt}{1}\selectfont%
  \fontsize{\fnts@spine}{\fnts@spine}\selectfont
  \typeout{NT SPINE \string\fontsize(author)=\fnts@author}%
  \typeout{NT SPINE \string\fontsize(title)=\fnts@title}%
  \typeout{NT SPINE \string\fontsize(final)=\fnts@spine}%
  \ifdatadefined{spine}(author){%
    \defifundef{\myauthorbox}{\newsavebox}%%
    \begin{lrbox}{\myauthorbox}%
      \begin{minipage}[c][\novathesis@spinetextwidth][c]{\thespine(text,author,len)}%
        % \begin{fitbox}{\linewidth}{\novathesis@boxwidth}%
          \@spinetextalin{author}%
          \@spinetextcolor{author}%
          \thespine(author)%
        % \end{fitbox}%
      \end{minipage}%
    \end{lrbox}%
  }{}%
  \ifdatadefined{spine}(title){%
    \defifundef{\mytitlebox}{\newsavebox}%%
    \begin{lrbox}{\mytitlebox}%
      \begin{minipage}[c][\novathesis@spinetextwidth][c]{\thespine(text,title,len)}%
        % \begin{fitbox}{\linewidth}{\novathesis@boxwidth}%
          \@spinetextalin{title}%
          \@spinetextcolor{title}%
          \thespine(title)%
        % \end{fitbox}%
      \end{minipage}%
    \end{lrbox}%
  }{}%
  \ifdatadefined{spine}(date){%
    \defifundef{\mydatebox}{\newsavebox}%%
    \begin{lrbox}{\mydatebox}%
      \begin{minipage}[c][\novathesis@spinetextwidth][c]{\thespine(text,date,len)}%
        % \begin{fitbox}{\linewidth}{\novathesis@boxwidth}%
          \@spinetextalin{date}%
          \@spinetextcolor{date}%
          \thespine(date)%
        % \end{fitbox}%
      \end{minipage}%
    \end{lrbox}%
  }{}%
  \ifoptionvoid{/novathesis/degreeacr}{}{%
    \defifundef{\mydegreebox}{\newsavebox}%%
    \begin{lrbox}{\mydegreebox}%
      \begin{minipage}[c][\novathesis@spinetextwidth][c]{\thespine(text,degree,len)}%
        % \begin{fitbox}{\linewidth}{\novathesis@boxwidth}%
          \@spinetextalin{degree}%
          \@spinetextcolor{degree}%
          \MakeTextUppercase{\option{/novathesis/degreeacr}}%
        % \end{fitbox}%
      \end{minipage}%
    \end{lrbox}%
  }%
  \options{/@ntcoveropts/bookmark=spine}%
  \phantomsection\currentpdfbookmark{\option{/@ntcoveropts/bookmark}}{sipne}%
  \NTRunHook{spine/pre}%
  \IfStrEq{#1}{trim}{
    \setstocksize{\paperheight}{\novathesis@spinewidth}
    \settrimmedsize{\stockheight}{\stockwidth}{*}%
    \setlrmarginsandblock{0pt}{0pt}{*}%
    \setulmarginsandblock{0pt}{*}{1}%
    \setheadfoot{0pt}{0pt}%
    \setheaderspaces{0pt}{*}{*}%
    \checkandfixthelayout[fixed]%
    \ifluatex
        \pagewidth=\novathesis@spinewidth% \pageheight=3in
    \else
        \pdfpagewidth=\novathesis@spinewidth% \pdfpageheight=3in
    \fi
  }{}%
  \thispagestyle{empty}%
  \begin{tikzpicture}[remember picture, overlay]
  % draw image
    % print bg color IF DEFINED
    \ifdatadefined{thesiscover}(\option{/novathesis/docdegree},spine,bgcolor){%
      \node[inner sep=0, anchor=center,
            rectangle, minimum width=\paperwidth, minimum height=\paperheight,
            fill=\expanded{\thethesiscover(\option{/novathesis/docdegree},spine,bgcolor)}]
           at (current page.center)
              {};
    }{}%
    % print bg image IF DEFINED
    \ifdatadefined{thesiscover}(\option{/novathesis/docdegree},spine,image){%
      \node[inner sep=0] at (current page.center)
              {\includegraphics[width=\novathesis@spinewidth,height=\paperheight]%
                               {\thethesiscover(\option{/novathesis/docdegree},spine,image)}%
              };
    }{}%
    % print logo IF DEFINED
    \ifdatadefined{spine}(logo,\option{/novathesis/docdegree}){%
      \node[inner sep=0,anchor=center,yshift=-0.5*\expanded{\thespine(box,logo,len)}
            ,xshift=-\novathesis@boxwidth*\expanded{\thespine(logo,\option{/novathesis/docdegree},raise)}]
           at (current page.north)
              {\includegraphics[width=\novathesis@boxwidth
                               ,angle=\expanded{\thespine(logo,\option{/novathesis/docdegree},angle)}
                               ,scale=\expanded{\thespine(logo,\option{/novathesis/docdegree},scale)}%
                               ]{\thespine(logo,\option{/novathesis/docdegree})}%
              };
    }{}
    % print author
    \ifdatadefined{spine}(author){%
      \def\@node@fillcolor{none}%
      \ifdatadefined{spine}(box,author,color){\edef\@node@fillcolor{\thespine(box,author,color)}}{}%
      \ifdatadefined{spine}(box,color){\edef\@node@fillcolor{\thespine(box,color)}}{}%
      \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,author,top)})
            ,rectangle,minimum width=\novathesis@boxwidth,minimum height=\expanded{\thespine(box,author,len)}
            ,fill=\@node@fillcolor]
           at (current page.north)
              {\rotatebox{\thespine(text,angle)}{\hspace*{\thespine(box,margin)}\usebox{\myauthorbox}}};
    }{}
    % print title
    \ifdatadefined{spine}(title){%
      \def\@node@fillcolor{none}%
      \ifdatadefined{spine}(box,title,color){\edef\@node@fillcolor{\thespine(box,title,color)}}{}%
      \ifdatadefined{spine}(box,color){\edef\@node@fillcolor{\thespine(box,color)}}{}%
      \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,title,top)})
            ,rectangle,minimum width=\novathesis@boxwidth,minimum height=\expanded{\thespine(box,title,len)}
            ,fill=\@node@fillcolor]
           at (current page.north) 
              {\rotatebox{\thespine(text,angle)}{\hspace*{\thespine(box,margin)}\usebox{\mytitlebox}}};
    }{}
    % print degree IF DEFINED
    \ifoptionvoid{/novathesis/degreeacr}{}{%
      \def\@node@fillcolor{none}%
      \ifdatadefined{spine}(box,degree,color){\edef\@node@fillcolor{\thespine(box,degree,color)}}{}%
      \ifdatadefined{spine}(box,color){\edef\@node@fillcolor{\thespine(box,color)}}{}%
      \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,degree,top)})
            ,rectangle,minimum width=\novathesis@boxwidth,minimum height=\expanded{\thespine(box,degree,len)}
            ,fill=\@node@fillcolor]
           at (current page.north)
              {\hspace*{\thespine(box,margin)}\rotatebox{\thespine(text,angle)}{\usebox{\mydegreebox}}};
    }
    % print date
    \ifdatadefined{spine}(date){%
      \def\@node@fillcolor{none}%
      \ifdatadefined{spine}(box,date,color){\edef\@node@fillcolor{\thespine(box,date,color)}}{}%
      \ifdatadefined{spine}(box,color){\edef\@node@fillcolor{\thespine(box,color)}}{}%
      \node[inner sep=0,anchor=north,yshift=-(\expanded{\thespine(box,date,top)})
            ,rectangle,minimum width=\novathesis@boxwidth,minimum height=\expanded{\thespine(box,date,len)}
            ,fill=\@node@fillcolor]
           at (current page.north)
              {\rotatebox{\thespine(text,angle)}{\hspace*{\thespine(box,margin)}\usebox{\mydatebox}}};
    }{}
  \end{tikzpicture}
  \iftoggle{/novathesis/debugcover}{\debuggrid}{}%
  \NTRunHook{spine/post}%
}
